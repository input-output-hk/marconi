%%% ---------------- L machine ---------------- %%%

\begin{figure*}[!ht]
\caption{The L Machine}
\begin{subfigure}[c]{\linewidth}   %%% ---------------- L machine states ---------------- %%%
{\small
\caption{States}
\[
\begin{array}{lrcl}
        \textrm{Stack}          & s      & ::= & f^*\\
        \textrm{Heap locations} & l      &  & \\
        \textrm{Heap entries}   & e      & ::= & \texttt{Unevaluated } M\quad|\quad\texttt{Evaluated } V \\
        \textrm{Environment}    & \rho   & ::= & [x \mapsto l]^*\\
        \textrm{Heap}           & \rho   & ::= & [l \mapsto e]^*\\
        \textrm{State}          & \sigma & ::= & s;\rho;h \compute M \quad| \quad s;\rho;h \return V  \quad| \quad \ckerror{} \quad|\quad \square V,\rho,h     
    \end{array}
\]
}
\end{subfigure}

\vspace{2mm}
\hrule
\vspace{2.5mm}

\begin{subfigure}[c]{\linewidth}     %%% ---------------- L machine frames ---------------- %%%
{
\small
\caption{Reduction frames}
\[
    \begin{array}{rlr}
      f :: = & \inInstLeftFrame{A}                     & \textrm{left instantiation}\\
             & \inWrapRightFrame{\alpha}{A}            & \textrm{right wrap}\\
             & \inUnwrapFrame{}                        & \textrm{unwrap}\\
             & \inLamLeftFrame{x}{M}                   & \textrm{$\lambda$}\\
             & \inAppLeftFrame{M}                      & \textrm{left application}\\
             & \inAppRightFrame{V}                     & \textrm{right application}\\
             & \inBuiltin{bn}{A^*}{V^*}{\_}{M^*}        & \textrm{builtin}\\
    \end{array}
\]
}
\end{subfigure}

\vspace{2mm}
\hrule
\vspace{2.5mm}

\begin{subfigure}[c]{\linewidth}   %%% ---------------- L machine transitions ---------------- %%%
{
\small
\caption{Transitions}
\begin{alignat*}{2}\\
      s;\rho;h  &\compute  \con{cn}               &{}\mapsto{}& s;\rho;h \return \con{cn}\\
      \blue{s; \rho; h} &\bcompute \blue{x}       &{}\bmapsto{}& \blue{s;\rho \return V \quad (h[\rho[x]] = \texttt{Evaluated}\ V)}\\  %% New rule
      \blue{s; \rho; h} &\bcompute \blue{x}       &{}\bmapsto{}& \blue{??? \quad (h[\rho[x]] = \texttt{Unevaluated}\ M)}\\  %% New rule
      s;\rho;h  &\compute \abs{\alpha}{K}{V}      &{}\mapsto{}& s;\rho;h \return \abs{\alpha}{K}{V}\\
      s;\rho;h &\compute \inst{M}{A}              &{}\mapsto{}& s;\rho;h \compute \inInstLeftFrame{A}{M}\\
      s;\rho;h &\compute \wrap{\alpha}{A}{M}      &{}\mapsto{}& s;\rho;h \compute \inWrapRightFrame{\alpha}{A}{M}\\
      s;\rho;h &\compute \unwrap{M}               &{}\mapsto{}& s;\rho;h \compute \inUnwrapFrame{}{M}\\
      s;\rho;h &\compute \lam{x}{A}{M}            &{}\mapsto{}& s;\rho;h \return \lam{x}{A}{M}\\
      s;\rho;h &\compute \app{M}{N}               &{}\mapsto{}& s;\rho;h \compute \inAppLeftFrame{N}{M}\\
      s;\rho;h &\compute \builtin{bn}{\repetition{A}}{} &{}\mapsto{}& U \quad (\textit{$bn$ computes on $\repetition{A}$ to $U$})\\
      s;\rho;h &\compute \builtin{bn}{\repetition{A}}{M \repetition{M}} &{}\mapsto{}& s;\rho \compute \inBuiltin{bn}{\repetition{A}}{}{\_}{\repetition{M}}{M}\\
      s; \rho;h &\compute \error{A} &{}\mapsto{}& \ckerror{}\\
      \cdot; \rho &\return V &{}\mapsto{}& \square V, \rho, h\\
      s,\inInstLeftFrame{A}; \rho;h &\return \abs{\alpha}{K}{M} &{}\mapsto{}& s;\rho;h \compute{M} \\
      s,\inWrapRightFrame{\alpha}{A}; \rho;h &\return V &{}\mapsto{}& s;\rho;h \return \wrap{\alpha}{A}{V}\\
      s,\inUnwrapFrame{}; \rho;h &\return {\wrap{\alpha}{A}{V}} &{}\mapsto{}& s;\rho;h \return V\\
      s,\inAppLeftFrame{N}; \rho;h &\return V &{}\mapsto{}& s, \inAppRightFrame{V};\rho;h \compute N\\
      s,\inAppRightFrame{\lam{x}{A}{M}}; \rho;h &\return V &{}\mapsto{}& s;\rho[x\mapsto V];h \compute M\\
      s,\inBuiltin
      {bn}
      {\repetition{A}}
      {\repetition{V}}{\_}{}; \rho; h &\return V &{}\mapsto{}& U \quad (\textit{$bn$ computes on $\repetition{A}$ and $\repetition{V}V$ to $U$})\\
      s,  \inBuiltin{bn}{\repetition{A}}{\repetition{V}}{\_}{M \repetition{M}}{}; \rho; h
          &\return V &{}\mapsto{}& s, \inBuiltin{bn}{\repetition{A}}{\repetition{V} V}{\_}{\repetition{M}} \compute M\\
%%    &\cksteps{\ckbackward{s, \inBuiltin{bn}{\repetition{A}}{\repetition{V}}{\_}{M \repetition{M}}}{V}}{\ckforward{s, \inBuiltin{bn}{\repetition{A}}{\repetition{V} V}{\_}{\repetition{M}}}{M}
%%        &\cksteps{\ckbackward{s, \inBuiltin{bn} {\repetition{A}} {\repetition{V} V} {\_} {} }{V}}{U} \qquad \textit{$bn$ co    \end{array}
\end{alignat*}
}
\end{subfigure}
\end{figure*}


